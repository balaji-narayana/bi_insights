<!-- Permissions Tab - admin_permissions.html -->

<style>
    /* Permissions Tab Specific Styles */
    #permissions .dept-badge {
        display: inline-block;
        background: #e6f2ff;
        color: #0066cc;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 5px;
    }
</style>

<div id="permissions" class="tab-content-section">
    <div class="page-header">
        <h2>Permissions</h2>
        <p>Manage dashboard access permissions</p>
    </div>

    <div class="card-modern">
        <div class="card-header-modern">
            <h5><i class="fas fa-lock"></i> Manage Permissions</h5>
            {% if role != 'superuser' %}
            <button class="btn-primary-modern" onclick="openGrantPermissionModal()">
                <i class="fas fa-shield-alt"></i> Grant Permission
            </button>
            {% else %}
            <div style="text-align: right; color: #f59e0b; font-weight: 600; font-size: 12px;">
                <i class="fas fa-lock"></i> Read-Only Mode
            </div>
            {% endif %}
        </div>
        <div class="card-body-modern">
            {% if permissions %}
                <table id="permissionsTable" class="table table-hover">
                    <thead>
                        <tr>
                            <th>DASHBOARD</th>
                            <th>DEPARTMENT</th>
                            <th>ROLES</th>
                            <th>GRANTED BY</th>
                            <th>DATE</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for perm in permissions %}
                        <tr>
                            <td><strong>{{ perm['DashboardName'] }}</strong></td>
                            <td><span class="dept-badge">{{ perm['DepartmentName'] }}</span></td>
                            <td><span style="color: #718096; font-size: 12px;">All</span></td>
                            <td>{{ perm['GrantedBy'] }}</td>
                            <td>{{ perm['GrantedAt'].strftime('%Y-%m-%d') if perm['GrantedAt'] else 'N/A' }}</td>
                            <td>
                                {% if role != 'superuser' %}
                                <button class="action-btn delete" onclick="revokePermission({{ perm['DepartmentDashboardID'] }})" title="Revoke Access">
                                    <i class="fas fa-lock"></i> Revoke
                                </button>
                                {% else %}
                                <button class="action-btn delete" disabled title="Read-only mode">
                                    <i class="fas fa-lock"></i> Revoke
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p><strong>No permissions granted yet</strong></p>
                    <p>Grant dashboard access to departments</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Grant Permission Modal -->
<div class="modal fade" id="grantPermissionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-shield-alt"></i> Grant Dashboard Permission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Dashboard <span style="color: #f56565;">*</span></label>
                    <select class="form-select" id="permissionDashboard">
                        <option value="">-- Select Dashboard --</option>
                        {% for dashboard in dashboards %}
                        <option value="{{ dashboard['DashboardID'] }}">{{ dashboard['DashboardName'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Department <span style="color: #f56565;">*</span></label>
                    <select class="form-select" id="permissionDepartment">
                        <option value="">-- Select Department --</option>
                        {% for dept in departments %}
                        <option value="{{ dept['DepartmentID'] }}">{{ dept['DepartmentName'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="background: #f7fafc; padding: 12px; border-radius: 6px; margin-top: 10px;">
                    <small style="color: #718096;"><i class="fas fa-info-circle"></i> Leave empty for all roles in the department</small>
                </div>
            </div>
            <div class="modal-footer" style="gap: 10px; border-top: 1px solid var(--border-color); padding: 16px 24px;">
                <button type="button" class="btn-primary-modern" style="background: #718096; width: auto;" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-primary-modern" style="width: auto;" onclick="grantPermission()">Grant Access</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Permissions Tab Specific Scripts

    function openGrantPermissionModal() {
        if (isSuperuser) {
            alert('You do not have permission to grant dashboard permissions (Read-only mode)');
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById('grantPermissionModal'));
        modal.show();
    }

    function grantPermission() {
        const dashboardId = document.getElementById('permissionDashboard').value.trim();
        const departmentId = document.getElementById('permissionDepartment').value.trim();

        if (!dashboardId || !departmentId) {
            alert('Please select both dashboard and department');
            return;
        }

        showLoading();

        fetch('/admin/grant-dashboard-permission', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                dashboard_id: parseInt(dashboardId),
                department_id: parseInt(departmentId)
            })
        })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if (d.success) {
                alert('Permission granted successfully!');
                bootstrap.Modal.getInstance(document.getElementById('grantPermissionModal')).hide();
                location.reload();
            } else {
                alert('Error: ' + d.error);
            }
        })
        .catch(err => {
            hideLoading();
            alert('Error granting permission: ' + err.message);
        });
    }

    function revokePermission(permissionId) {
        if (isSuperuser) {
            alert('You do not have permission to revoke dashboard permissions (Read-only mode)');
            return;
        }
        if (!confirm('Are you sure you want to revoke this permission?')) return;

        showLoading();

        fetch(`/admin/revoke-dashboard-permission/${permissionId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if (d.success) {
                alert('Permission revoked successfully!');
                location.reload();
            } else {
                alert('Error: ' + d.error);
            }
        })
        .catch(err => {
            hideLoading();
            alert('Error revoking permission: ' + err.message);
        });
    }

    $(document).ready(function() {
        {% if permissions %}
        const commonConfig = {
            pageLength: 10,
            autoWidth: false,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            }
        };

        $('#permissionsTable').DataTable({
            ...commonConfig,
            order: [[4, 'desc']],
            language: {
                ...commonConfig.language,
                info: "Showing _START_ to _END_ of _TOTAL_ permissions"
            }
        });
        {% endif %}
    });
</script>
