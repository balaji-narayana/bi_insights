<!-- Configuration Testing Tab - admin_configuration.html -->

<style>
    /* Configuration Tab Specific Styles */
    #configuration .info-display {
        background: #f8f9fc;
        border-left: 4px solid #667eea;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    #configuration .info-display .label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 4px;
        font-weight: 600;
    }

    #configuration .info-display .value {
        font-size: 13px;
        color: var(--text-primary);
        word-break: break-all;
        font-weight: 600;
    }

    /* Page Header with Clear Button */
    #configuration .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 25px;
    }

    #configuration .page-header > div {
        flex: 1;
    }

    /* Clear Button Styling */
    .btn-clear {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .btn-clear:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(237, 137, 54, 0.3);
    }

    .btn-clear i {
        font-size: 14px;
    }

    /* Responsive Form Layout */
    @media (max-width: 575px) {
        /* Mobile - single column */
        #configuration .page-header {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
            margin-bottom: 20px;
        }

        #configuration .page-header > div {
            flex: none;
        }

        #configuration .form-row {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        #configuration .form-group {
            margin-bottom: 16px;
        }

        #configuration .form-group label {
            font-size: 13px;
            margin-bottom: 8px;
        }

        #configuration .form-control {
            padding: 10px 12px;
            font-size: 14px;
        }

        #configuration .page-header h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        #configuration .page-header p {
            font-size: 13px;
        }

        #configuration .card-body-modern {
            padding: 16px;
        }

        #configuration .info-display {
            padding: 12px;
            margin-bottom: 12px;
        }

        #configuration .info-display .label {
            font-size: 10px;
            margin-bottom: 4px;
        }

        #configuration .info-display .value {
            font-size: 12px;
        }

        .btn-clear {
            width: 100%;
            justify-content: center;
            padding: 12px 16px;
            font-size: 13px;
        }
    }

    @media (min-width: 576px) and (max-width: 768px) {
        /* Small Tablet - 2 columns */
        #configuration .form-row {
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        #configuration .form-group {
            margin-bottom: 12px;
        }

        #configuration .page-header {
            flex-direction: row;
            align-items: center;
            gap: 16px;
        }

        #configuration .page-header h2 {
            font-size: 22px;
        }

        #configuration .card-body-modern {
            padding: 20px;
        }

        .btn-clear {
            padding: 10px 16px;
            font-size: 12px;
        }
    }

    @media (min-width: 769px) and (max-width: 1023px) {
        /* Large Tablet - 2 columns */
        #configuration .form-row {
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        #configuration .page-header {
            flex-direction: row;
            align-items: center;
            gap: 16px;
        }

        #configuration .page-header h2 {
            font-size: 24px;
        }

        #configuration .card-body-modern {
            padding: 25px;
        }

        .btn-clear {
            padding: 11px 20px;
            font-size: 13px;
        }
    }

    @media (min-width: 1024px) {
        /* Desktop - 2 columns for form rows */
        #configuration .page-header {
            flex-direction: row;
            align-items: center;
            gap: 20px;
        }

        #configuration .form-row {
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        #configuration .page-header h2 {
            font-size: 26px;
        }

        #configuration .card-body-modern {
            padding: 30px;
        }

        .btn-clear {
            padding: 12px 28px;
        }
    }
</style>

<div id="configuration" class="tab-content-section">
    <div class="page-header">
        <div>
            <h2>Configuration Testing</h2>
            <p>Test Azure AD & Power BI configuration</p>
        </div>
        <button class="btn-clear" onclick="clearForm()">
            <i class="fas fa-eraser"></i> Clear
        </button>
    </div>

    <div class="card-modern">
        <div class="card-header-modern">
            <h5><i class="fas fa-key"></i> Azure AD & Power BI Config</h5>
        </div>
        <div class="card-body-modern">
            <div class="form-row">
                <div class="form-group">
                    <label>Client ID <span style="color: #f56565;">*</span></label>
                    <input type="text" class="form-control" id="client_id" placeholder="Enter Client ID">
                </div>
                <div class="form-group">
                    <label>Tenant ID <span style="color: #f56565;">*</span></label>
                    <input type="text" class="form-control" id="tenant_id" placeholder="Enter Tenant ID">
                </div>
            </div>
            <div class="form-group">
                <label>Client Secret <span style="color: #f56565;">*</span></label>
                <input type="password" class="form-control" id="client_secret" placeholder="Enter Client Secret">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Report ID <span style="color: #f56565;">*</span></label>
                    <input type="text" class="form-control" id="report_id" placeholder="Enter Report ID">
                </div>
                <div class="form-group">
                    <label>Group ID <span style="color: #f56565;">*</span></label>
                    <input type="text" class="form-control" id="group_id" placeholder="Enter Group ID">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Core Dataset ID <span style="color: #f56565;">*</span></label>
                    <input type="text" class="form-control" id="core_dataset" placeholder="Enter Core Dataset ID">
                </div>
                <div class="form-group">
                    <label>Proxy Dataset ID</label>
                    <input type="text" class="form-control" id="proxy_dataset" placeholder="Optional">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" id="config_username" placeholder="Leave empty for default (session email)">
                    <small style="color: #718096; margin-top: 6px; display: block;"><i class="fas fa-info-circle"></i> Optional - if not provided, your email will be used</small>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <input type="text" class="form-control" id="config_role" placeholder="Leave empty for default (RM)">
                    <small style="color: #718096; margin-top: 6px; display: block;"><i class="fas fa-info-circle"></i> Optional - if not provided, RM will be used</small>
                </div>
            </div>
            <button class="btn-primary-modern" style="width: 100%; justify-content: center;" id="generateBtn" onclick="generateToken()">
                <i class="fas fa-bolt"></i> Generate Token & URL
            </button>

            <div id="resultCard" style="margin-top: 20px; display: none;">
                <h5 id="resultTitle" style="margin-bottom: 15px; color: #48bb78;">âœ… Success!</h5>

                <div class="info-display" id="workspaceDisplay" style="display: none;">
                    <div class="label"><i class="fas fa-building"></i> Workspace Name</div>
                    <div class="value" id="workspaceValue"></div>
                </div>

                <div class="info-display" id="reportDisplay" style="display: none;">
                    <div class="label"><i class="fas fa-file-chart-line"></i> Report Name</div>
                    <div class="value" id="reportValue"></div>
                </div>

                <div class="info-display" id="usernameDisplay" style="display: none;">
                    <div class="label"><i class="fas fa-user"></i> Username Used</div>
                    <div class="value" id="usernameValue"></div>
                </div>

                <div class="info-display" id="roleDisplay" style="display: none;">
                    <div class="label"><i class="fas fa-user-tag"></i> Role Used</div>
                    <div class="value" id="roleValue"></div>
                </div>

                <div style="margin-top: 15px; padding: 15px; background: #f8f9fc; border-radius: 8px; border: 1px solid var(--border-color);">
                    <small style="color: var(--text-secondary); font-weight: 600;"><i class="fas fa-lock"></i> Token:</small>
                    <div style="font-family: 'Courier New', monospace; font-size: 11px; margin-top: 8px; max-height: 80px; overflow-y: auto; padding: 8px; background: white; border-radius: 4px;" id="tokenValue"></div>
                    <button class="btn-primary-modern" onclick="copyToClipboard('tokenValue')" style="margin-top: 10px; width: auto;">
                        <i class="fas fa-copy"></i> Copy Token
                    </button>
                </div>

                <div style="margin-top: 15px; padding: 15px; background: #f8f9fc; border-radius: 8px; border: 1px solid var(--border-color);">
                    <small style="color: var(--text-secondary); font-weight: 600;"><i class="fas fa-link"></i> Embed URL:</small>
                    <div style="font-family: 'Courier New', monospace; font-size: 11px; margin-top: 8px; max-height: 80px; overflow-y: auto; padding: 8px; background: white; border-radius: 4px;" id="urlValue"></div>
                    <button class="btn-primary-modern" onclick="copyToClipboard('urlValue')" style="margin-top: 10px; width: auto;">
                        <i class="fas fa-copy"></i> Copy URL
                    </button>
                </div>

                <button class="btn-primary-modern" id="viewReportBtn" onclick="viewReport()" style="margin-top: 15px; display: none; width: 100%; justify-content: center;">
                    <i class="fas fa-eye"></i> View Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Configuration Tab Specific Scripts

    function generateToken() {
        const clientId = document.getElementById('client_id').value.trim();
        const tenantId = document.getElementById('tenant_id').value.trim();
        const clientSecret = document.getElementById('client_secret').value.trim();
        const reportId = document.getElementById('report_id').value.trim();
        const groupId = document.getElementById('group_id').value.trim();
        const coreDataset = document.getElementById('core_dataset').value.trim();
        const proxyDataset = document.getElementById('proxy_dataset').value.trim();
        const username = document.getElementById('config_username').value.trim();
        const role = document.getElementById('config_role').value.trim();

        if (!clientId || !tenantId || !clientSecret || !reportId || !groupId || !coreDataset) {
            alert('Please fill in all required fields');
            return;
        }

        showLoading();

        fetch('/admin/generate-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                client_id: clientId,
                tenant_id: tenantId,
                client_secret: clientSecret,
                report_id: reportId,
                group_id: groupId,
                core_dataset: coreDataset,
                proxy_dataset: proxyDataset || '',
                username: username || '',
                role: role || ''
            })
        })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if (d.success) {
                tokenData = d;
                displayTokenResult(d);
            } else {
                alert('Error: ' + d.error);
                console.error('Error details:', d);
            }
        })
        .catch(err => {
            hideLoading();
            alert('Error generating token: ' + err.message);
            console.error(err);
        });
    }

    function displayTokenResult(data) {
        const resultCard = document.getElementById('resultCard');
        resultCard.style.display = 'block';

        if (data.workspace_name) {
            document.getElementById('workspaceValue').textContent = data.workspace_name;
            document.getElementById('workspaceDisplay').style.display = 'block';
        }

        if (data.report_name) {
            document.getElementById('reportValue').textContent = data.report_name;
            document.getElementById('reportDisplay').style.display = 'block';
        }

        if (data.username_used) {
            document.getElementById('usernameValue').textContent = data.username_used;
            document.getElementById('usernameDisplay').style.display = 'block';
        }

        if (data.role_used) {
            document.getElementById('roleValue').textContent = data.role_used;
            document.getElementById('roleDisplay').style.display = 'block';
        }

        document.getElementById('tokenValue').textContent = data.token || 'N/A';
        document.getElementById('urlValue').textContent = data.embed_url || 'N/A';
        document.getElementById('viewReportBtn').style.display = data.embed_url ? 'flex' : 'none';
    }

    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert('Copied to clipboard!');
        }).catch(err => {
            console.error('Copy failed:', err);
            alert('Failed to copy');
        });
    }

    function viewReport() {
        if (!tokenData.token || !tokenData.embed_url) {
            alert('Token or URL not available');
            return;
        }

        const url = `/view-report?token=${encodeURIComponent(tokenData.token)}&embedUrl=${encodeURIComponent(tokenData.embed_url)}&reportId=${encodeURIComponent(tokenData.report_id || '')}&reportName=${encodeURIComponent(tokenData.report_name || '')}`;
        window.location.href = url;
    }

    function clearForm() {
        // Clear all input fields
        document.getElementById('client_id').value = '';
        document.getElementById('tenant_id').value = '';
        document.getElementById('client_secret').value = '';
        document.getElementById('report_id').value = '';
        document.getElementById('group_id').value = '';
        document.getElementById('core_dataset').value = '';
        document.getElementById('proxy_dataset').value = '';
        document.getElementById('config_username').value = '';
        document.getElementById('config_role').value = '';

        // Hide result card if visible
        const resultCard = document.getElementById('resultCard');
        if (resultCard) {
            resultCard.style.display = 'none';
        }

        // Focus on first input field
        document.getElementById('client_id').focus();
    }
</script>
